<html>
  <head>
    <title>Halva</title>
    <script src="https://unpkg.com/vue@2.4.4/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="/data"></script>
    <meta content='width=device-width, initial-scale=1.0, user-scalable=1' name='viewport' />
    <meta name="theme-color" content="#555" />
    <style>
      body {
        margin: 0;
        text-align: center;
        background-color: 0;
        color:  #ccc;
      }

      p {
        margin: 10px 0;
      }

      form {
        width:  100%;
        margin: 0;
      }

      button {
        width:  128px;
        height: 64px;
        margin: 16px;
        border: 0;
        color:  #ccc;
        background-color: #555;
        outline: none;
      }

      /*
      button.closed {
        background-color: #242;
      }
      */

      button.open {
        background-color: #622;
      }

      button:active {
        background-color: #999;
        color:  #fff;
      }

      button.open:active {
        background-color: #c77;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <door v-for="door in doors" v-bind="door" :key="door.name"></door>

      <div v-if="display_video">
        <img width="100%" style="-webkit-user-select: none" src="/video.mjpg">
        <p @click="forcePhoto">Force to still image</p>
      </div>
      <div v-else>
        <img width="100%" name="garage_view" style="-webkit-user-select: none" v-bind:src="img_src" @click="refreshImage">
      </div>

    </div>

    <script>
      Vue.component('door', {
        template: '<button v-bind:class="classObject" @click="toggle">{{ name }} ({{ status }})</button>',
        props:    ['name', 'status', 'is_closed'],
        methods:  {
          toggle: function() {
            axios.post('/toggle', {
              toggle: this.name,
            }).then(function (data, status, request) {
            }).catch(function() {
            });
          },
        },
        computed: {
          classObject: function() {
            var closed = !!this.is_closed;
            return {
              'closed': closed,
              'open':   !closed,
            };
          },
        },
      });

      function merge(source, destination) {
        var keys = Object.keys(source);
        keys.forEach(function(key) {
          destination[key] = source[key];
        });
      }

      var data = {
        timestamp:     Date.now(),
        display_video: false,
        video_url:     '',
        doors:         [],
      };

      merge(window.app_data, data);

      var app = new Vue({
        el: '#app',
        data: data,
        created: function() {
          this.setupStream();
        },
        computed: {
          img_src: function() {
            return "/recent_image.jpg?ts=" + this.timestamp;
          },
        },
        methods: {
          forcePhoto: function() {
            this.display_video = false;
          },
          refreshImage: function() {
            this.timestamp = Date.now();
          },
          refetch: function() {
            axios.get('/data?format=json&ts=' + Date.now(), {
              toggle: this.name,
            }).then(function (res, status, request) {
              merge(res.data, app.$data);
            }).catch(function() {
            });
          },
          setupStream: function() {
            var source = new EventSource('/updates');

            source.addEventListener('message', event => {
              var data;
              try {
                data = JSON.parse(event.data);

                this.timestamp = Date.now(); // trigger an image update if the door has closed.

                this.doors = data.doors;
              } catch(err) {
                console.log('err, err.stack', err, err.stack);
              }
            });

            source.addEventListener('error', event => {
              console.log('error:', event);
            });
          }
        },
      });

      // if the user focuses away and then comes back, we should fetch fresh state from the server
      var hidden, visibilityChange;
      if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support
        hidden = "hidden";
        visibilityChange = "visibilitychange";
      } else if (typeof document.msHidden !== "undefined") {
        hidden = "msHidden";
        visibilityChange = "msvisibilitychange";
      } else if (typeof document.webkitHidden !== "undefined") {
        hidden = "webkitHidden";
        visibilityChange = "webkitvisibilitychange";
      }

      (function() {
        var focused = true;
        function handleVisibilityChange(e) {
          var new_status = (document[hidden]) ? false : true;

          if (focused === false && new_status === true) {
            app.refetch();
          }

          focused = new_status;
        }

        if (typeof document.addEventListener === "undefined") {
          console.log("This demo requires a browser, such as Google Chrome or Firefox, that supports the Page Visibility API.");
        } else {
          // Handle page visibility change
          document.addEventListener(visibilityChange, handleVisibilityChange, false);
        }
      }());
    </script>
  </body>
</html>
